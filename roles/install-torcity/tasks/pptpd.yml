---
# Author: Vagner Rodrigues Fernandes <vagner.rodrigues@gmail.com>
# Description: Install and configure pptpd server 
# Requirements: 
#

- name: CONFIGURE PPTPD LOCALIP
  lineinfile:
    path: /etc/pptpd.conf
    line: 'localip 10.0.0.1'

- name: CONFIGURE PPTPD REMOTEIP
  lineinfile:
    path: /etc/pptpd.conf
    line: 'remoteip 10.0.0.100-200'

- name: CONFIGURE PPTP USER
  lineinfile:
    path: /etc/ppp/chap-secrets
    line: 'vagnerd pptpd 1234 *'

- name: CONFIGURE PPTP USER
  lineinfile:
    path: /etc/ppp/pptpd-options
    line: 'ms-dns 8.8.8.8'

- name: SET SYSCTL TO ALLOW EXTERNAL ROUTING
  sysctl:
    name: net.ipv4.ip_forward
    value: 1
    reload: yes
    state: present

#- name: LOAD IPTABLES MASQUAREDE RULE
#  iptables:
#    table: nat
#    chain: POSTROUTING
#    out_interface: eth0
#    jump: MASQUERADE

- name: LOAD IPTABLES MASQUAREDE DNS TCP RULE
  iptables:
    table: nat
    chain: POSTROUTING
    out_interface: eth0
    protocol: tcp
    destination_port: 53
    jump: MASQUERADE

- name: LOAD IPTABLES MASQUAREDE DNS UDP RULE
  iptables:
    table: nat
    chain: POSTROUTING
    out_interface: eth0
    protocol: udp
    destination_port: 53
    jump: MASQUERADE


- name: LOAD IPTABLES PROXY TRANSPARENT RULE
  iptables:
    table: nat
    chain: PREROUTING
    in_interface: ppp0
    source: 10.0.0.0/24
    protocol: tcp
    destination_port: 80
    to_ports: 15379
    jump: REDIRECT

- name: RESTART PPTPD SERVER
  service:
    name: pptpd
    state: restarted
    enabled: true

- name: COPY PRIVOXY CONFIG SERVER
  copy:
    src: multitor/privoxy.cfg
    dest: /opt/multitor/etc/privoxy.cfg

- name: RELOAD PRIVOXY
  shell: |
    kill `ps auxw  | grep -i privoxy | awk '{ print $2 }' | head -n1`
    privoxy /opt/multitor/bin/../etc/privoxy.cfg

#- name: GIT CLONE MULTITOR SOURCE PROJECT
#  git:
#    repo: 'https://github.com/trimstray/multitor.git'
#    dest: /opt/multitor
#    force: yes
#
#- name: EXECUTE SETUP MULTITOR SCRIPT
#  command: /opt/multitor/setup.sh install
#
#- name: COPY PRIVOXY TEMPLATE SERVER
#  copy:
#    src: multitor/privoxy-template.cfg
#    dest: /opt/multitor/templates/privoxy-template.cfg
#
#- name: SET SYSCTL TO ALLOW LOCAL ROUTING
#  sysctl:
#    name: net.ipv4.conf.all.route_localnet
#    value: 1
#    reload: yes
#    state: present
#
#- name: LOAD IPTABLES DNAT PORT 8080
#  iptables:
#    table: nat
#    chain: PREROUTING
#    protocol: tcp
#    destination_port: 8080
#    jump: DNAT
#    to_destination: 127.0.0.1:15379
